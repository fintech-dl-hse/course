
**Recap:**
Tрансформер - это модель авторегрессивной генерации.
Это значит, что:
  - За один шаг мы генерируем обычно один токен
  - Каждый новый токен зависит от всех предыдущих

$$ P(x_t | x_1, x_2, ..., x_{t-1}) $$

---

**Генерация без KV-Cache**

На каждом шаге перевычисляются эмбэддинги для вообще всех
токенов, не только для последнего. Поэтому количество вычислений
растет квадратично с длинной последовательности.

*Решение:*
Стандартная практика сэкономить вычисления - это закэшировать результат.

---

**Генерация с KV-Cache**

Количество вычислений растет линейно. Но требуется дополнительная память для кэширования
результатов, вычисленных на предыдущих шагах.

---

Итого:

|             | Per Layer Memory     | Per token Computation |
| --- | --- | --- |
| No KV-Cache  |  O(1)          | O(n^2)       |
| KV-Cache     |  O(n)          | O(n)         |


**TODO** добавить визуализацию квадратичной сложности вычислений
**TODO** пример для реальной модельки, на сколько KV-Cache ускоряет генерацию и сколько использует памяти.

---

Блиц:
* Можно ли использовать KV-Cache во время обучения?
    KV-Cache используется только во время инференса. Во время обучения трансформер не генерирует новые токены. А эмбэддинги для входной последовательности вычисляются параллельно в `prefill` режиме. Об этом мы расскажем в следующем видео.
* Сколько памяти занимает KV-Cache?
    - TODO посчитать график для 3B, 8B модели

---

Квиз:

* Если рассмотреть асиимптотику по вычислениям для генерации с KV-Cache не одного токена, а последовательности `n` токенов, какая будет сложность?
- O(1)
- O(n)
- O(n^2)
- O(n^3)

Правильный ответ - `O(n^2)`, потому что если для каждого токена требуется `O(n)` вычислений, то для генерации `n` токенов, потребуется `O(n^2)`.

* Если рассмотреть асиимптотику по вычислениям для генерации БЕЗ KV-Cache не одного токена, а последовательности `n` токенов, какая будет сложность?
- O(n)
- O(n^2)
- O(n^3)
- O(n^4)

Правильный ответ - `O(n^3)`, потому что если для каждого токена требуется `O(n^2)` вычислений, то для генерации `n` токенов, потребуется `O(n^3)`.
