# Agentic AI

Краткие заметки по построению агентных систем: степени автономии, ключевые паттерны, инструменты, оценка качества и организация мультиагентных флоу. Скомпоновано по мотивам [курса Andrew Ng по агентским системам](https://learn.deeplearning.ai/courses/agentic-ai/).

### Степени автономии

- Минимальная: заранее заданная последовательность шагов (сформировать запрос, выполнить поиск и т. д.).
- Средняя: агент сам решает, когда вызывать инструменты и когда остановиться; возможны петли.
- Максимальная: LLM создаёт и использует инструменты на лету.

Чем выше автономность, тем меньше контроля, сложнее валидация и больше непредсказуемости.

### Зачем агентность

- Качество: на HumanEval gpt-3.5 хуже gpt-4, но агентские надстройки часто догоняют и показывают высокие метрики.
- Скорость: часть работы можно распараллелить (например, поиск и суммаризацию).

### Декомпозиция

Разбивайте задачу на шаги — так предсказуемее и стабильнее.

### Базовые паттерны

- Reflection: агент получает обратную связь от среды и улучшает результат сам или с помощью критика.
- Tools: поиск, исполнение кода, калькулятор, валидаторы и т. д.
- Planning: планирование и пошаговое исполнение.
- Multi-agent: кооперация нескольких агентов.

### Reflection

Итеративное улучшение результата.
- Черновик можно генерировать более простой моделью, а последующие шаги — сильной.
- Исполнение кода даёт обратную связь от среды.
- Обратную связь можно получать от отдельного критика.

Есть работа (Self-Refine), где показано, что рефлексия стабильно улучшает результаты на множестве задач.

{% note tip %}
Лучше заранее зафиксировать критерии: что именно улучшать и что проверять.
{% endnote %}

### Инструменты (Tools)

Инструменты помогают LLM:
- Делать детерминированно хорошо (компилятор, валидатор HTML, калькулятор).
- Доставать недоступное модели (поиск, текущее время и т. д.).

Технически инструмент — это функция, принимающая аргументы и возвращающая текст. Сильный класс инструментов — исполнение кода. Оно даёт мгновенную обратную связь (включая синтаксические ошибки) и хорошо сочетается с рефлексией. Но запуск кода требует аккуратности — лучше исполнять в изолированных окружениях/контейнерах.

### Оценка и отладка

#### Объективная оценка

- Сгенерируйте множество ответов, вручную выявите типовые проблемы (например, агент упоминает конкурентов).
- Для каждой проблемы обновляйте промт и добавляйте объективные метрики/тесты (например, поиск запрещённых строк в ответе).
- Поддерживайте уровни оценки: end‑to‑end и по компонентам.

#### Субъективная оценка (LLM-as-a-Judge)

Если ошибку нельзя проверить кодом, используйте LLM как судью.
- Проблемы при сравнении двух результатов: position bias, плохие ответы.
- Вместо одной общей оценки лучше использовать несколько бинарных критериев с фиксированной формулировкой.

#### По-компонентный анализ

Если агент работает многостадийно, проблема может возникать на любом этапе, включая инструменты.
- Сохраняйте трейсы работы (и время каждого этапа).
- Периодически просматривайте результаты каждого шага.
- Анализируйте ошибки по шагам, чтобы понимать, где чаще всего возникают проблемы и каков их корень.

{% note warning %}
Мораль: длинные агентные флоу — это боль. Если в начале что-то сломалось, дальнейшие шаги работают с плохими данными.
{% endnote %}

**Компоненты без LLM**

- Тюнинг гиперпараметров.
- Замена компонента.

**Компоненты на LLM**

- Улучшение промта (явные инструкции, примеры).
- Попробовать другую модель (выбор по результатам оценок).
- Декомпозировать шаги.
- Доводить модель (fine‑tune), если другое не помогло.

Читайте промты других людей и проектов — это помогает быстрее улучшать свои.

### Наблюдаемость (Observability)

- Логируйте время работы каждого этапа и количество токенов (для учёта стоимости).

### Высокоавтономные агенты

#### Планирование

Сначала попросите модель описать план: список инструментов и задач по шагам. После рассуждения можно попросить структурировать план в JSON, чтобы снизить неоднозначность.

#### Планирование с исполнением кода

ReAct обычно работает лучше, чем планирование через JSON или чистый текст.

### Мультиагентные флоу

Хотя LLM — это по сути одни и те же веса, промт имеет значение. Разбиение задачи на роли и подзадачи часто помогает.

#### Зачем несколько агентов
- Разные системные промты.
- Для разных агентов может требоваться разный набор инструментов.

#### Паттерны коммуникации
- Линейная коммуникация: детерминированный (запрограммированный) флоу.
- Иерархическая коммуникация. Агент‑менеджер использует других агентов как инструменты: получает результат их работы, ставит задачи и решает, кого вызывать дальше. Иерархия может быть глубокой.
- All‑to‑all: каждый агент общается с каждым. Редко встречается и сложно управляется.

Вызывайте других агентов не как код, а через JSON‑контракты.

Пример глубокой иерархии:
- Агент‑менеджер
  - Исследователь
    - Факт‑чекер
    - Исследователь интернета
  - Графический дизайнер
  - Писатель
    - Рецензент

